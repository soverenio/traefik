version: "3"

services:
  backend:
    image: nginx
    expose:
      - "8080"
    volumes:
      - ./backend.conf:/etc/nginx/conf.d/backend.conf
  proxy:
    image: soveren/traefik-exp:local
    build:
      context: ../..
      dockerfile: exp.Dockerfile
    ports:
      - "8090:8090"
    environment:
      TRAEFIK_LOG_LEVEL: INFO
      TRAEFIK_PROVIDERS_FILE_DIRECTORY: /etc/traefik/conf/conf.d/
      TRAEFIK_ENTRYPOINTS_WEB_ADDRESS: ":8090"
    volumes:
      - ./traefik_configs:/etc/traefik/conf
  zookeeper:
    image: soveren/zookeeper:bn-3.7
    expose:
      - "2181"
    volumes:
      - "zookeeper_data:/bitnami"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
  kafka:
    image: soveren/kafka:wm-2.13-2.7.1
    expose:
     - "9092"
    volumes:
      - "kafka_data:/kafka"
    environment:
      - KAFKA_BROKER_ID=0
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      # pre-creating topics with given number of partitions
      - KAFKA_CREATE_TOPICS=alive:1:1,events:10:1:compact
      - KAFKA_ALLOW_AUTOCREATE_TOPICS=false
      # configure listener (plaintext only)
      - KAFKA_ADVERTISED_LISTENERS=INSIDE://kafka:9092
      - KAFKA_LISTENERS=INSIDE://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INSIDE:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=INSIDE
      # one hour retention
      - KAFKA_LOG_RETENTION_MS=3600000
      # 256mb retention
      - KAFKA_LOG_RETENTION_BYTES=268435456

volumes:
  zookeeper_data:
    driver: local
  kafka_data:
    driver: local
